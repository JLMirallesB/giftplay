# API de Comunicaci√≥n PeerJS

Documentaci√≥n del protocolo de mensajes entre Presentador y Jugadores en GIFTPlay.

## Arquitectura

GIFTPlay utiliza **PeerJS** (basado en WebRTC) para comunicaci√≥n P2P sin servidor backend centralizado.

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê         PeerJS          ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   PRESENTADOR   ‚îÇ ‚óÑ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∫ ‚îÇ  JUGADOR 1  ‚îÇ
‚îÇ   (Host/Server) ‚îÇ                         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
‚îÇ                 ‚îÇ         PeerJS
‚îÇ                 ‚îÇ ‚óÑ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∫ ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                 ‚îÇ                         ‚îÇ  JUGADOR 2  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Servidor PeerJS

- **Host**: `0.peerjs.com`
- **Puerto**: `443` (HTTPS)
- **STUN/TURN**: Servidores de relay.metered.ca

---

## Estructura de Mensajes

Todos los mensajes siguen el formato:

```javascript
{
    tipo: string,      // Tipo de mensaje
    payload: object    // Datos del mensaje
}
```

---

## Mensajes: Jugador ‚Üí Presentador

### `join`

Solicitud de unirse a la partida.

**Datos:**
```javascript
{
    tipo: 'join',
    payload: {
        nombre: string  // Nombre del jugador (incluye emoji)
    }
}
```

**Ejemplo:**
```javascript
{
    tipo: 'join',
    payload: {
        nombre: 'üéÆ Pedro'
    }
}
```

---

### `answer`

Env√≠o de respuesta a una pregunta.

**Datos:**
```javascript
{
    tipo: 'answer',
    payload: {
        respuesta: number | number[],  // √çndice(s) de respuesta (0-based)
        tiempoRespuesta: number          // Tiempo en ms desde que se mostr√≥ la pregunta
    }
}
```

**Ejemplos:**

Respuesta √∫nica:
```javascript
{
    tipo: 'answer',
    payload: {
        respuesta: 2,           // Opci√≥n C (√≠ndice 2)
        tiempoRespuesta: 3450   // 3.45 segundos
    }
}
```

Respuesta m√∫ltiple:
```javascript
{
    tipo: 'answer',
    payload: {
        respuesta: [0, 2],      // Opciones A y C
        tiempoRespuesta: 5200
    }
}
```

---

## Mensajes: Presentador ‚Üí Jugador

### `join_confirmed`

Confirmaci√≥n de que el jugador se uni√≥ exitosamente.

**Datos:**
```javascript
{
    tipo: 'join_confirmed',
    payload: {
        jugadoresConectados: number  // Total de jugadores conectados
    }
}
```

---

### `game_started`

Notificaci√≥n de que el juego ha comenzado.

**Datos:**
```javascript
{
    tipo: 'game_started',
    payload: {
        totalPreguntas: number  // N√∫mero total de preguntas
    }
}
```

---

### `question`

Nueva pregunta para responder.

**Datos:**
```javascript
{
    tipo: 'question',
    payload: {
        pregunta: string,           // Texto de la pregunta (Markdown + LaTeX)
        opciones: [                 // Array de opciones (solo texto, sin info de correcci√≥n)
            { texto: string },
            { texto: string },
            ...
        ],
        tipo: string,               // 'multiple-choice-single', 'multiple-choice-multiple', 'true-false'
        multimedia: string,         // HTML de multimedia (img, video, iframe) o vac√≠o
        numeroPregunta: number,     // N√∫mero de pregunta actual (1-based)
        totalPreguntas: number,     // Total de preguntas
        tiempo: number              // Segundos para responder
    }
}
```

**Ejemplo:**
```javascript
{
    tipo: 'question',
    payload: {
        pregunta: '¬øCu√°l es la capital de Francia?',
        opciones: [
            { texto: 'Madrid' },
            { texto: 'Par√≠s' },
            { texto: 'Roma' },
            { texto: 'Londres' }
        ],
        tipo: 'multiple-choice-single',
        multimedia: '',
        numeroPregunta: 1,
        totalPreguntas: 10,
        tiempo: 30
    }
}
```

---

### `answer_received`

Confirmaci√≥n de que la respuesta fue recibida.

**Datos:**
```javascript
{
    tipo: 'answer_received',
    payload: {}
}
```

---

### `result`

Resultado de la pregunta actual.

**Datos:**
```javascript
{
    tipo: 'result',
    payload: {
        esCorrecta: boolean | number,  // true/false o 0-100 para ponderado
        puntosGanados: number,          // Puntos ganados en esta pregunta
        puntosTotal: number,            // Puntos totales acumulados
        respuestaCorrecta: [            // Info de las respuestas correctas
            {
                index: number,
                texto: string,
                correcta: boolean,
                peso: number
            }
        ],
        feedback: string                // Feedback de la respuesta (puede estar vac√≠o)
    }
}
```

**Ejemplo:**
```javascript
{
    tipo: 'result',
    payload: {
        esCorrecta: true,
        puntosGanados: 1000,
        puntosTotal: 3000,
        respuestaCorrecta: [
            {
                index: 1,
                texto: 'Par√≠s',
                correcta: true,
                peso: 100
            }
        ],
        feedback: '¬°Correcto! Par√≠s es la capital de Francia desde 987 d.C.'
    }
}
```

---

### `final_result`

Resultados finales del juego.

**Datos:**
```javascript
{
    tipo: 'final_result',
    payload: {
        puntuacionFinal: number,        // Puntos totales del jugador
        puntuacionMaxima: number,       // M√°xima puntuaci√≥n posible
        respuestasCorrectas: number,    // N√∫mero de respuestas correctas
        totalPreguntas: number,         // Total de preguntas
        posicion: number                // Posici√≥n en el ranking (1-based)
    }
}
```

**Ejemplo:**
```javascript
{
    tipo: 'final_result',
    payload: {
        puntuacionFinal: 7500,
        puntuacionMaxima: 10000,
        respuestasCorrectas: 8,
        totalPreguntas: 10,
        posicion: 2    // Segundo lugar
    }
}
```

---

### `pause`

Notificaci√≥n de pausa del juego.

**Datos:**
```javascript
{
    tipo: 'pause',
    payload: {}
}
```

---

### `resume`

Notificaci√≥n de reanudaci√≥n del juego.

**Datos:**
```javascript
{
    tipo: 'resume',
    payload: {
        tiempoRestante: number  // Segundos restantes de la pregunta
    }
}
```

---

### `kicked`

Notificaci√≥n de expulsi√≥n.

**Datos:**
```javascript
{
    tipo: 'kicked',
    payload: {
        razon: string  // Raz√≥n de la expulsi√≥n
    }
}
```

---

### `error`

Mensaje de error.

**Datos:**
```javascript
{
    tipo: 'error',
    payload: {
        mensaje: string  // Descripci√≥n del error
    }
}
```

---

## Flujo de Comunicaci√≥n

### 1. Conexi√≥n

```
JUGADOR                         PRESENTADOR
   ‚îÇ                                  ‚îÇ
   ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ connect(gameId) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ>‚îÇ
   ‚îÇ                                  ‚îÇ
   ‚îÇ<‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ connection open ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÇ
   ‚îÇ                                  ‚îÇ
   ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ tipo: 'join' ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ>‚îÇ
   ‚îÇ                                  ‚îÇ
   ‚îÇ<‚îÄ‚îÄ‚îÄ tipo: 'join_confirmed' ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÇ
```

### 2. Inicio del Juego

```
PRESENTADOR                     JUGADORES
   ‚îÇ                                  ‚îÇ
   ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ tipo: 'game_started' ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ>‚îÇ
   ‚îÇ                                  ‚îÇ
   ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ tipo: 'question' ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ>‚îÇ
```

### 3. Respuesta y Resultado

```
JUGADOR                         PRESENTADOR
   ‚îÇ                                  ‚îÇ
   ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ tipo: 'answer' ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ>‚îÇ
   ‚îÇ                                  ‚îÇ
   ‚îÇ<‚îÄ‚îÄ tipo: 'answer_received' ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÇ
   ‚îÇ                                  ‚îÇ
   ‚îÇ<‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ tipo: 'result' ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÇ
```

### 4. Finalizaci√≥n

```
PRESENTADOR                     JUGADORES
   ‚îÇ                                  ‚îÇ
   ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ tipo: 'final_result' ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ>‚îÇ
```

---

## C√≥digos de Estado

### Estados del Juego

| Estado | Descripci√≥n |
|--------|-------------|
| `inicio` | Pantalla inicial de carga de archivo |
| `lobby` | Esperando jugadores |
| `jugando` | Juego en curso |
| `resultado` | Mostrando resultado de pregunta |
| `finalizado` | Juego terminado |

### Estados de Conexi√≥n PeerJS

| Evento | Descripci√≥n |
|--------|-------------|
| `open` | Conexi√≥n establecida |
| `connection` | Nueva conexi√≥n de jugador (solo presentador) |
| `data` | Mensaje recibido |
| `close` | Conexi√≥n cerrada |
| `error` | Error en la conexi√≥n |
| `disconnected` | Desconectado del servidor PeerJS |

---

## Manejo de Errores

### Errores Comunes

| Error | Causa | Soluci√≥n |
|-------|-------|----------|
| `peer-unavailable` | El c√≥digo de partida no existe | Verificar el c√≥digo |
| `network` | Problema de red | Revisar conexi√≥n a internet |
| `server-error` | Error del servidor PeerJS | Reintentar m√°s tarde |
| `browser-incompatible` | Navegador no soporta WebRTC | Usar Chrome, Firefox o Edge |

### Reconexi√≥n

GIFTPlay **NO** implementa reconexi√≥n autom√°tica. Si un jugador se desconecta:

1. El jugador es marcado como `conectado: false`
2. No puede volver a unirse a la misma partida
3. Debe esperar a una nueva partida

---

## L√≠mites y Restricciones

| Aspecto | L√≠mite |
|---------|--------|
| Jugadores simult√°neos | ~50 (recomendado: 20-30) |
| Tama√±o de mensaje | ~1 MB |
| Duraci√≥n de conexi√≥n | Ilimitada (mientras el presentador est√© activo) |
| Latencia t√≠pica | 50-200 ms |

---

## Seguridad

### ‚ö†Ô∏è Importante

- **NO** se env√≠a informaci√≥n sensible
- Las respuestas **NO est√°n cifradas** end-to-end (confianza en PeerJS)
- El presentador puede ver todas las respuestas en tiempo real
- **NO** hay autenticaci√≥n de jugadores (solo nombre + emoji)

### Recomendaciones

- Usar en redes confiables (WiFi de la instituci√≥n educativa)
- No compartir c√≥digos de sesi√≥n p√∫blicamente
- El presentador debe validar nombres ofensivos manualmente

---

## Ejemplo de Implementaci√≥n

### Presentador

```javascript
const peerManager = new PeerManager();

// Inicializar
const gameId = await peerManager.initialize();

// Escuchar jugadores
peerManager.onPlayerJoin((jugador) => {
    console.log(`${jugador.nombre} se uni√≥`);
});

// Enviar pregunta a todos
peerManager.broadcast(
    Protocol.createQuestionMessage(pregunta, 1, 10, 30)
);
```

### Jugador

```javascript
const peerClient = new PeerClient();

// Conectar
await peerClient.connect('ABCDE', 'üéÆ Pedro');

// Escuchar preguntas
peerClient.onQuestion((payload) => {
    console.log('Nueva pregunta:', payload.pregunta);
});

// Enviar respuesta
peerClient.sendAnswer(2, 3450); // Opci√≥n C, 3.45s
```

---

## Referencias

- [PeerJS Documentation](https://peerjs.com/docs/)
- [WebRTC Specification](https://www.w3.org/TR/webrtc/)
- [C√≥digo fuente: protocol.js](../src/shared/protocol.js)

---

**Documentaci√≥n actualizada:** 2025-10-19
